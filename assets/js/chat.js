(function(){if(window.__AM_CHAT_INIT__)return;window.__AM_CHAT_INIT__=!0;if(typeof window.AM_AUTO_AUDIO!=='boolean')window.AM_AUTO_AUDIO=!0;document.querySelectorAll('.openai-chat-container').forEach((root)=>{if(root.__AM_INIT__)return;root.__AM_INIT__=!0;const scrollerEl=root;const messagesEl=root.querySelector('.openai-messages')||root;const form=root.querySelector('#openai-chat-form');const input=root.querySelector('#openai-message-input');const voiceBtn=root.querySelector('#openai-voice-btn');if(voiceBtn)voiceBtn.setAttribute('type','button');const disclaimer=root.querySelector('.am-coach-note');if(disclaimer){const toggle=disclaimer.querySelector('.am-coach-toggle');if(toggle){toggle.addEventListener('click',()=>{disclaimer.classList.toggle('expanded');if(root.AM_positionScrollBtn)root.AM_positionScrollBtn();})}}
// Tag input functionality for the chat field has been removed.

const agentId=parseInt(root.dataset.agentId||'0',10);let convUid=String(root.dataset.convUid||'');const assistantName=root.dataset.assistantName||'Assistant';const voiceId=(root.dataset.voiceId||'').trim();const welcome=root.dataset.welcome||'Hi!';const showFab=root.dataset.feedbackFab==='1';const avatarUrl=root.dataset.avatarUrl||'';const scrollIcon=root.dataset.scrollIcon||'https://wa4u.ai/wp-content/uploads/2025/08/nav-arrow-down.svg';let initialLoad=!0;function getChatKey(){return `amChatOpts-agent-${agentId}`}(function setupAutoScroll(){if(!scrollerEl)return;const EPS=64;let userLocked=!!convUid;function isNearBottom(){const remaining=scrollerEl.scrollHeight-scrollerEl.clientHeight-scrollerEl.scrollTop;return remaining<=EPS}
function scrollToBottom(smooth=!0){scrollerEl.scrollTo({top:scrollerEl.scrollHeight,behavior:smooth?'smooth':'auto',})}
const goEndBtn=document.createElement('button');goEndBtn.type='button';goEndBtn.className='am-scroll-bottom';goEndBtn.setAttribute('aria-label','Ir al final');Object.assign(goEndBtn.style,{position:'absolute',left:'50%',transform:'translateX(-50%)',display:'none',width:'40px',height:'40px',borderRadius:'20px',border:'1px solid rgba(0,0,0,.1)',boxShadow:'0 6px 18px rgba(0,0,0,.18)',background:'#fff',cursor:'pointer',zIndex:'10',padding:'0',alignItems:'center',justifyContent:'center'});const iconImg=document.createElement('img');iconImg.src=scrollIcon;iconImg.alt='Ir al final';iconImg.width=20;iconImg.height=20;Object.assign(iconImg.style,{pointerEvents:'none'});goEndBtn.appendChild(iconImg);goEndBtn.dataset.cid=convUid||Math.random().toString(36).slice(2);root.appendChild(goEndBtn);function positionBtn(){const form=root.querySelector('.openai-chat-form');const h=form?form.offsetHeight:0;goEndBtn.style.bottom=`${h + 16}px`}
positionBtn();window.addEventListener('resize',positionBtn);goEndBtn.addEventListener('click',()=>{userLocked=!1;scrollToBottom(!0);updateState()});function updateState(){const scrollable=scrollerEl.scrollHeight>scrollerEl.clientHeight+EPS;userLocked=scrollable&&!isNearBottom();goEndBtn.style.display=userLocked?'flex':'none'}
scrollerEl.addEventListener('scroll',updateState,{passive:!0});const mo=new MutationObserver((mutations)=>{let added=!1;for(const m of mutations){if(m.addedNodes&&m.addedNodes.length){added=!0;break}}
if(!added)return;updateState()});mo.observe(messagesEl,{childList:!0,subtree:!0});root.AM_isNearBottom=isNearBottom;root.AM_scrollToBottom=scrollToBottom;root.AM_userLocked=()=>userLocked;root.AM_setUserLocked=(val)=>{userLocked=!!val};root.AM_scrollBtn=goEndBtn;root.AM_positionScrollBtn=positionBtn;userLocked=!1;updateState()})();appendBubble('ai',escapeHtml(welcome),!0,!0);initialLoad=!1;const sendBtn=root.querySelector('.send');const callBtn=root.querySelector('.am-voice-call-btn');let toggleCallBtn=null;const inputInner=root.querySelector('.openai-input-inner');const transcribingImg=root.dataset.transcribingImg||'https://wa4u.ai/wp-content/uploads/2025/09/transcribing.svg';let sttOverlay=null;if(inputInner){inputInner.style.position='relative';sttOverlay=document.createElement('div');sttOverlay.className='am-stt-loading';sttOverlay.style.display='none';inputInner.appendChild(sttOverlay)}
if(input&&callBtn){toggleCallBtn=()=>{callBtn.style.display=input.value.trim()?'none':''};input.addEventListener('input',toggleCallBtn);toggleCallBtn()}
if(voiceBtn&&navigator.mediaDevices){let mediaRecorder=null;let chunks=[];let isRecording=!1;let micStream=null;function updateVoiceBtn(state){voiceBtn.classList.toggle('listening',state==='listening');voiceBtn.innerHTML=state==='listening'?'<img src="https://wa4u.ai/wp-content/uploads/2025/09/STOP-RECORDING.svg" alt="Stop" width="20" height="20">':'<img src="https://wa4u.ai/wp-content/uploads/2025/08/mic-on.svg" alt="Mic" width="20" height="20">';if(sendBtn)sendBtn.style.display=state==='listening'?'none':'';if(callBtn)callBtn.style.display=state==='listening'?'none':''}
async function startRecording(){if(isRecording)return;chunks=[];if(micStream){try{micStream.getTracks().forEach((t)=>t.stop())}catch(_){}
micStream=null}
try{micStream=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(err){console.error('getUserMedia error',err);return}
const mime=MediaRecorder.isTypeSupported('audio/webm')?'audio/webm':'audio/mp4';mediaRecorder=new MediaRecorder(micStream,{mimeType:mime});mediaRecorder.ondataavailable=(e)=>{if(e.data.size>0)chunks.push(e.data);};mediaRecorder.onstop=async()=>{if(micStream){micStream.getTracks().forEach((t)=>t.stop());micStream=null}
if(!chunks.length){if(sttOverlay)sttOverlay.style.display='none';if(voiceBtn)voiceBtn.style.display='';if(sendBtn)sendBtn.style.display='';updateVoiceBtn('idle');if(callBtn)callBtn.style.display='none';mediaRecorder=null;return}
if(sttOverlay){sttOverlay.innerHTML=transcribingImg?`<img src="${transcribingImg}" alt="Transcribing...">`:'Transcribing...';sttOverlay.style.display='flex'}
if(voiceBtn)voiceBtn.style.display='none';if(sendBtn)sendBtn.style.display='none';if(callBtn)callBtn.style.display='none';const ext=mime==='audio/webm'?'webm':'mp4';const file=new File(chunks,`audio.${ext}`,{type:mime});const fd=new FormData();fd.append('file',file);const rawLang=root.dataset.sttLang||'';if(rawLang){fd.append('language',rawLang.split('-')[0].toLowerCase())}
try{const r=await fetch(window.AM_REST+'am/v1/stt',{method:'POST',body:fd,headers:{'X-WP-Nonce':window.AM_NONCE},credentials:'same-origin'});if(!r.ok){const txt=await r.text();console.error('STT HTTP error',r.status,txt)}else{const j=await r.json();if(j&&j.text){const text=(j.text||'').trim();const letters=(text.match(/[\w\u00C0-\u017F]/g)||[]).length;if(text&&letters>=4&&letters/text.length>=0.5){const pre=input.value?input.value+' ':'';input.value=pre+text;autosize()}}}}catch(err){console.error('STT error:',err)}
if(sttOverlay)sttOverlay.style.display='none';if(voiceBtn)voiceBtn.style.display='';if(sendBtn)sendBtn.style.display='';updateVoiceBtn('idle');if(callBtn)callBtn.style.display='none';mediaRecorder=null};mediaRecorder.start();isRecording=!0;updateVoiceBtn('listening');if(sttOverlay){sttOverlay.innerHTML='Listening...';sttOverlay.style.display='flex'}}
function stopRecording(){if(!isRecording)return;isRecording=!1;if(mediaRecorder)mediaRecorder.stop();}
voiceBtn.addEventListener('click',(e)=>{e.preventDefault();if(!isRecording)startRecording();else stopRecording()})}else if(voiceBtn){voiceBtn.style.display='none'}
if(convUid){fetch(window.AM_REST+'am/v1/history?conversation_uid='+encodeURIComponent(convUid),{credentials:'same-origin',headers:{'X-WP-Nonce':window.AM_NONCE},}).then((r)=>r.json()).then((j)=>{const items=(j&&j.items)?j.items:[];items.forEach((it)=>{const cleanedText=it.role==='user'?escapeHtml(String(it.content||'')):sanitizeReply(String(it.content||''));const wrap=appendBubble(it.role==='user'?'user':'ai',cleanedText,it.role!=='user',!0);if(it.role!=='user'){const mid=it.assistant_message_id||it.message_id||it.id;const row=wrap.querySelector('.am-feedback-row');if(row)addFeedbackButtons(row,stripHtml(cleanedText),mid);}})}).catch(()=>{})}
const MAX_ROWS=6;function autosize(){input.style.height='auto';const lh=parseFloat(getComputedStyle(input).lineHeight)||20;const maxH=lh*MAX_ROWS;input.style.height=Math.min(input.scrollHeight,maxH)+'px';input.style.overflowY=input.scrollHeight>maxH?'auto':'hidden'}
input&&input.addEventListener('input',(e)=>{autosize();clearSuggestions(!0)});input&&autosize();input&&input.addEventListener('keydown',(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();if(form){if(form.requestSubmit)form.requestSubmit();else form.dispatchEvent(new Event('submit',{cancelable:!0}))}}});if(form&&!form.__amBound){form.addEventListener('submit',onSubmit);form.__amBound=!0}
async function onSubmit(e){e.preventDefault();clearSuggestions();const text=(input.value||'').trim();if(!text)return;appendBubble('user',escapeHtml(text));if(root.AM_setUserLocked)root.AM_setUserLocked(!1);input.value='';autosize();if(toggleCallBtn)toggleCallBtn();const typing=appendBubble('ai','<div class="typing-indicator"><span></span><span></span><span></span></div>',!1);try{const payload={agent_id:agentId,message:text,conversation_uid:convUid||'',options:(window.AM_CHAT_OPTS&&window.AM_CHAT_OPTS[getChatKey()])||{}};console.log('Sending request:',{url:window.AM_REST+'am/v1/chat',payload});const resp=await fetch(window.AM_REST+'am/v1/chat',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json','X-WP-Nonce':window.AM_NONCE},credentials:'same-origin',body:JSON.stringify(payload),});console.log('Response headers:',{contentType:resp.headers.get('content-type'),status:resp.status});const rawText=await resp.text();console.log('Raw response:',rawText);let data;try{data=JSON.parse(rawText)}catch(jsonError){console.error('JSON Parse Error:',jsonError);throw new Error('Server returned invalid JSON response')}
if(!resp.ok){throw new Error(data?.error||`HTTP ${resp.status}`)}
if(data&&data.conversation_uid){convUid=data.conversation_uid;const url=new URL(window.location.href);url.searchParams.set('agent_id',String(agentId));url.searchParams.set('cid',String(convUid));window.history.replaceState({},'',url.toString());window.dispatchEvent(new CustomEvent('am:conversation-updated',{detail:{cid:convUid,agentId,title:text.slice(0,60),avatarUrl,assistantName}}))}
const rawReply=applyMutedWords(String(data.reply||''));const replyHtml=sanitizeReply(rawReply);const replyText=stripHtml(replyHtml);addPlayToLastAIBubble(replyText);const lastPlayBtn=typing.querySelector('.play-btn');if(lastPlayBtn&&window.AM_AUTO_AUDIO)lastPlayBtn.click();const bubbleEl=typing.querySelector('.bubble');await typeInto(bubbleEl,escapeHtml(replyText));bubbleEl.innerHTML=replyHtml;const sugs=extractSuggestions(data.suggestions,rawReply,text);showSuggestions(sugs,typing);
const row=typing.querySelector('.am-feedback-row');if(row)addFeedbackButtons(row,replyText,data.assistant_message_id);}catch(err){console.error('Chat error:',err);const b=typing.querySelector('.bubble');if(b){b.innerHTML=`<div class="error">Error: ${escapeHtml(err.message || 'Could not get response')}</div>`}}finally{if(callBtn)callBtn.style.display=''}}
if(showFab){const fab=document.createElement('div');fab.className='am-fb-fab';fab.innerHTML='<button class="up">üëç</button><button class="down">üëé</button>';fab.addEventListener('click',(e)=>e.stopPropagation());document.body.appendChild(fab)}
messagesEl.addEventListener('click',async(e)=>{const btn=e.target.closest('.play-btn');if(!btn)return;const img=btn.querySelector('img');if(!btn.dataset.playIcon&&img)btn.dataset.playIcon=img.src;if(btn.classList.contains('playing')){try{if(btn._audio){btn._audio.pause();btn._audio.currentTime=0}}catch(_){}
if(btn._audios){btn._audios.forEach(({audio,url})=>{try{audio.pause();audio.currentTime=0}catch(_){}
if(url){try{URL.revokeObjectURL(url)}catch(_){}}})}else if(btn._audioUrl){try{URL.revokeObjectURL(btn._audioUrl)}catch(_){}}
btn._audio=null;btn._audios=null;btn._audioUrl=null;btn.classList.remove('playing');btn.disabled=!1;if(img)img.src=btn.dataset.playIcon||img.src;return}
if(btn.classList.contains('loading'))return;const text=btn.dataset.text;if(!text)return;console.log('TTS Debug - Starting playback:',{text:text.substring(0,50)+'...',voiceId:voiceId,agentId:agentId});btn.disabled=!0;btn.classList.add('loading');if(img)img.src='https://wa4u.ai/wp-content/uploads/2025/08/loading.svg';try{const cleanText=text.replace(/&[a-zA-Z0-9#]+;/g,' ').replace(/\s+/g,' ').trim();if(!cleanText){throw new Error('No text content to convert to speech')}
const parts=splitForTts(cleanText,400);const audios=[];for(const part of parts){const payload={text:part,voice_id:voiceId||'',agent_id:agentId};console.log('TTS Debug - Sending payload:',payload);const r=await fetch(window.AM_REST+'am/v1/tts',{method:'POST',headers:{'Content-Type':'application/json','X-WP-Nonce':window.AM_NONCE},body:JSON.stringify(payload)});console.log('TTS Debug - Response status:',r.status,r.statusText);if(!r.ok){const errorText=await r.text();console.error('TTS API Error:',r.status,errorText);let errorMsg=`HTTP ${r.status}`;try{const errorData=JSON.parse(errorText);if(errorData.message)errorMsg=errorData.message;else if(errorData.error)errorMsg=errorData.error}catch(e){if(errorText.length>0&&errorText.length<200){errorMsg=errorText}}
throw new Error(`TTS API error: ${errorMsg}`)}
const blob=await r.blob();console.log('TTS Debug - Blob size:',blob.size,'bytes');if(blob.size<100){throw new Error('Received invalid audio data (too small)')}
const audioUrl=URL.createObjectURL(blob);const audio=new Audio(audioUrl);audios.push({audio,url:audioUrl})}
const reset=()=>{btn.classList.remove('playing');btn.classList.remove('loading');btn.disabled=!1;if(img)img.src=btn.dataset.playIcon||img.src;if(btn._audios){btn._audios.forEach(({audio,url})=>{try{audio.pause();audio.currentTime=0}catch(_){}
if(url){try{URL.revokeObjectURL(url)}catch(_){}}})}
btn._audio=null;btn._audios=null;btn._reset=null};btn._reset=reset;btn._audios=audios;const playSeq=(idx)=>{if(idx>=audios.length){reset();return}
const{audio,url}=audios[idx];btn._audio=audio;audio.addEventListener('error',()=>{console.error('TTS Debug - Audio error while playing chunk');reset()},{once:!0});audio.addEventListener('ended',()=>{playSeq(idx+1)},{once:!0});audio.play().catch((err)=>{console.error('TTS Debug - play error',err);reset()})};playSeq(0);btn.classList.remove('loading');btn.classList.add('playing');btn.disabled=!1;if(img)img.src='https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/icons/stop-circle.svg'}catch(err){console.error('TTS Debug - Error:',err);if(typeof btn._reset==='function'){btn._reset()}else{btn.classList.remove('playing');btn.classList.remove('loading');btn.disabled=!1;if(img)img.src=btn.dataset.playIcon||img.src}
let userMsg='Could not play audio. ';if(err.message.includes('API key')){userMsg+='API key not configured.'}else if(err.message.includes('voice')){userMsg+='Invalid voice ID.'}else if(err.message.includes('text')){userMsg+='No valid text content.'}else{userMsg+='Please check console for details.'}
alert(userMsg)}});function splitForTts(text,maxLen=400){const parts=[];let remaining=String(text||'').trim();while(remaining.length>maxLen){let idx=remaining.lastIndexOf('.',maxLen);if(idx<maxLen*0.6)idx=remaining.lastIndexOf(' ',maxLen);if(idx<=0)idx=maxLen;parts.push(remaining.slice(0,idx).trim());remaining=remaining.slice(idx).trim()}
if(remaining)parts.push(remaining);return parts}
function unquoteSmart(s){s=String(s||"").trim();s=s.replace(/^[‚Äú‚Äù"']+/,"").replace(/[‚Äú‚Äù"']+$/,"");s=s.replace(/,+\s*$/,"");return s.trim()}
function isGoodChip(s){s=String(s||"").trim().toLowerCase();if(!s)return!1;if(s==="["||s==="]"||s==="```"||s==="```json")return!1;if(/^```/.test(s))return!1;if(/^\[.*\]$/.test(s)&&!s.includes(","))return!1;return s.replace(/[^\p{L}\p{N}]+/gu,"").length>=2}
function ensureRelevant(list){return list.slice(0,3)}
function extractSuggestions(raw,reply,userText){const uniqueClean=(xs)=>[...new Set((xs||[]).map((x)=>unquoteSmart(x)))].filter(isGoodChip);let out=[];if(raw!=null){if(Array.isArray(raw)){out=raw.map((v)=>String(v));}else if(typeof raw==='string'){try{const parsed=JSON.parse(raw);if(Array.isArray(parsed))out=parsed.map((v)=>String(v))}catch(_){}}else if(typeof raw==='object'){const k=raw.suggestions??raw.chips??raw.buttons;if(Array.isArray(k))out=k.map((v)=>String(v));}}out=uniqueClean(out);if(!out.length)out=fallbackChips(reply,userText);return ensureRelevant(out)}
function appendBubble(role,html,withPlay,skipScroll=!1){const wrap=document.createElement('div');wrap.className='openai-bubble '+(role==='user'?'user':'ai');const avatar=document.createElement('div');avatar.className='avatar';const userLabel=root.dataset.userName||'Me';avatar.textContent=role==='user'?userLabel:assistantName;if(role!=='user'&&withPlay){const btn=document.createElement('button');btn.type='button';btn.className='play-btn';btn.setAttribute('data-text',stripHtml(html));btn.setAttribute('aria-label','Play voice');btn.innerHTML='<img src="https://wa4u.ai/wp-content/uploads/2025/08/play.svg" alt="Play" width="20" height="20">';avatar.appendChild(btn)}
const bubble=document.createElement('div');bubble.className='bubble';bubble.innerHTML=html;wrap.appendChild(avatar);wrap.appendChild(bubble);if(role==='ai'){const feedbackRow=document.createElement('div');feedbackRow.className='am-feedback-row';wrap.appendChild(feedbackRow)}
messagesEl.appendChild(wrap);if(role==='ai'){if(!initialLoad&&!skipScroll&&root.AM_setUserLocked)root.AM_setUserLocked(!1);}else{if(!skipScroll&&root.AM_setUserLocked)root.AM_setUserLocked(!1);}
if(root.AM_scrollToBottom)root.AM_scrollToBottom();
return wrap}
function addFeedbackButtons(row,replyText,msgId){if(!row||row.__fbMounted)return;row.__fbMounted=!0;const upUrl=root.dataset.fbUp||'https://wa4u.ai/wp-content/uploads/2025/08/thumbs-up.svg';const upActiveUrl=root.dataset.fbUpActive||upUrl;const downUrl=root.dataset.fbDown||'https://wa4u.ai/wp-content/uploads/2025/08/thumbs-down.svg';const downActiveUrl=root.dataset.fbDownActive||downUrl;const up=document.createElement('button');up.type='button';up.className='am-fb am-fb-up';up.setAttribute('aria-pressed','false');const upImg=document.createElement('img');upImg.src=upUrl;upImg.alt='Like';upImg.width=20;upImg.height=20;up.appendChild(upImg);const dn=document.createElement('button');dn.type='button';dn.className='am-fb am-fb-down';dn.setAttribute('aria-pressed','false');const dnImg=document.createElement('img');dnImg.src=downUrl;dnImg.alt='Dislike';dnImg.width=20;dnImg.height=20;dn.appendChild(dnImg);row.appendChild(up);row.appendChild(dn);function setActive(which){up.classList.toggle('active',which==='up');dn.classList.toggle('active',which==='down');up.setAttribute('aria-pressed',String(which==='up'));dn.setAttribute('aria-pressed',String(which==='down'));up.querySelector('img').src=which==='up'?upActiveUrl:upUrl;dn.querySelector('img').src=which==='down'?downActiveUrl:downUrl}
if(msgId){const saved=localStorage.getItem(`feedback-${msgId}`);if(saved==='up'||saved==='down')setActive(saved);}
async function send(val){if(!convUid||!msgId)return!1;try{const payload={conversation_uid:convUid,message_id:msgId,value:val,text:replyText||'',agent_id:agentId||0};const r=await fetch(window.AM_REST+'am/v1/feedback',{method:'POST',headers:{'Content-Type':'application/json','X-WP-Nonce':window.AM_NONCE},credentials:'same-origin',body:JSON.stringify(payload),});const j=await r.json();if(!r.ok)throw new Error(j?.error||'Error');localStorage.setItem(`feedback-${msgId}`,val);return!0}catch(err){console.error('Feedback error:',err);return!1}}
up.addEventListener('click',async()=>{if(up.disabled||dn.disabled)return;up.disabled=dn.disabled=!0;const ok=await send('up');if(ok)setActive('up');up.disabled=dn.disabled=!1});dn.addEventListener('click',async()=>{if(up.disabled||dn.disabled)return;up.disabled=dn.disabled=!0;const ok=await send('down');if(ok)setActive('down');up.disabled=dn.disabled=!1})}
async function typeInto(el,html,opts={}){const delayMs=typeof opts.delayMs==='number'?opts.delayMs:12;const charsPerTick=typeof opts.charsPerTick==='number'?opts.charsPerTick:2;const safe=String(html||'').replace(/\n/g,'<br>');const tokens=safe.split(/(<br>)/g);el.innerHTML='';let textNode=document.createTextNode('');el.appendChild(textNode);let skip=!1;const skipHandler=()=>{skip=!0};el.addEventListener('click',skipHandler,{once:!0});for(const t of tokens){if(t==='<br>'){el.appendChild(document.createElement('br'));textNode=document.createTextNode('');el.appendChild(textNode);if(root.AM_scrollToBottom)root.AM_scrollToBottom();continue}
let i=0;while(i<t.length){if(skip){textNode.nodeValue+=t.slice(i);i=t.length;break}
const next=t.slice(i,i+charsPerTick);textNode.nodeValue+=next;if(root.AM_scrollToBottom)root.AM_scrollToBottom();i+=next.length;await new Promise((r)=>setTimeout(r,delayMs))}}
try{el.removeEventListener('click',skipHandler,{once:!0})}catch(_){}}
function addPlayToLastAIBubble(text){const last=[...messagesEl.querySelectorAll('.openai-bubble.ai .avatar')].pop();if(!last)return;if(last.querySelector('.play-btn')){last.querySelector('.play-btn').setAttribute('data-text',text);return}
const btn=document.createElement('button');btn.type='button';btn.className='play-btn';btn.setAttribute('data-text',text);btn.setAttribute('aria-label','Play voice');btn.innerHTML='<img src="https://wa4u.ai/wp-content/uploads/2025/08/play.svg" alt="Play" width="20" height="20">';last.appendChild(btn)}
window.AM_addPlayToLastAIBubble=addPlayToLastAIBubble;function sanitizeReply(text){let out=String(text||'');out=out.replace(/```[\s\S]*?```/g,'');out=out.replace(/`{1,}/g,'');const tail=out.slice(-600);const range=findLastBalancedArrayRange(tail);if(range){const globalStart=out.length-tail.length+range.start;const globalEnd=out.length-tail.length+range.end+1;if(globalEnd>out.length-5){out=(out.slice(0,globalStart)+out.slice(globalEnd)).trim()}}
out=out.replace(/\s{3,}/g,'  ').trim();out=escapeHtml(out);out=out.replace(/&lt;(\/?(?:ul|ol|li|br|strong))&gt;/gi,'<$1>');out=out.replace(/\*\*(.+?)\*\*/g,'<strong>$1<\/strong>');out=out.replace(/(^|\n)\s*(?:[-*‚Ä¢]\s.+)(?:\n\s*[-*‚Ä¢]\s.+)*/g,(m)=>{const items=m.trim().split(/\n/).map(line=>line.replace(/^\s*[-*‚Ä¢]\s+/,''));return'<ul><li>'+items.join('</li><li>')+'</li></ul>'});out=out.replace(/(^|\n)\s*(?:\d+\.\s.+)(?:\n\s*\d+\.\s.+)*/g,(m)=>{const items=m.trim().split(/\n/).map(line=>line.replace(/^\s*\d+\.\s+/,''));return'<ol><li>'+items.join('</li><li>')+'</li></ol>'});out=out.replace(/\n/g,'<br>');return out}
function findLastBalancedArrayRange(s){let inStr=!1,quote='',esc=!1,depth=0,start=-1,last=null;for(let i=0;i<s.length;i++){const ch=s[i];if(esc){esc=!1;continue}
if(inStr){if(ch==='\\'){esc=!0;continue}
if(ch===quote){inStr=!1;quote=''}
continue}
if(ch==='"'||ch==="'"){inStr=!0;quote=ch;continue}
if(ch==='['){if(depth===0)start=i;depth++;continue}
if(ch===']'){if(depth>0){depth--;if(depth===0&&start!==-1){last={start,end:i}}}}}
return last}
let currentSugRow=null;function clearSuggestions(anim){if(currentSugRow){if(anim){currentSugRow.classList.add('fade');setTimeout(()=>currentSugRow&&currentSugRow.remove(),200)}else currentSugRow.remove();currentSugRow=null}}
function showSuggestions(list,afterEl){const opts=(window.AM_CHAT_OPTS&&window.AM_CHAT_OPTS[getChatKey()])||{};if(!list||!list.length||opts.chips===false||opts.chips==='0'){clearSuggestions();return}clearSuggestions();const row=document.createElement('div');row.className='am-suggestions';list.forEach((s)=>{const b=document.createElement('button');b.type='button';b.className='am-suggestion-chip';b.textContent=s;b.addEventListener('click',()=>{const pre=input.value?input.value+' ':'';input.value=pre+s;clearSuggestions(!0);input.focus();autosize();if(toggleCallBtn)toggleCallBtn()});row.appendChild(b)});afterEl.after(row);currentSugRow=row}
function escapeRegExp(s){return s.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')}
function applyMutedWords(text){const opts=(window.AM_CHAT_OPTS&&window.AM_CHAT_OPTS[getChatKey()])||{};const words=String(opts.muted||'').split(',').map((w)=>w.trim()).filter(Boolean);if(!words.length)return text;let out=String(text||'');words.forEach((w)=>{out=out.replace(new RegExp('\\b'+escapeRegExp(w)+'\\b','gi'),'***')});return out}
function fallbackChips(reply,userText){const text=(reply+' '+(userText||'')).toLowerCase();const isEs=/[√°√©√≠√≥√∫√±¬ø¬°]|(hola|c√≥mo|est√°s|gracias|ayuda|cu√©ntame|siento|triste|ansioso|ansiedad|estr√©s|hambre|comida)/i.test(text);if(isEs){if(/triste|depre|solo|ansio|ansied|estres|estr√©s|preocup/i.test(text))return['Quiero hablar de eso','¬øQu√© puedo hacer ahora?','Dame un ejercicio r√°pido'];if(/hambre|comer|comida|dieta/i.test(text))return['Recomi√©ndame algo saludable','Ideas de snacks r√°pidos','Consejos para organizar comidas'];}else{if(/sad|down|anxious|anxiety|stress|worried/i.test(text))return["Let‚Äôs talk about it","What should I do now?","Give me a quick exercise"];if(/hungry|food|eat|diet/i.test(text))return['Suggest something healthy','Quick snack ideas','Tips to plan meals'];}return[]}
function escapeHtml(s){return(s||'').replace(/[&<>]/g,(c)=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}
function stripHtml(s){const tmp=document.createElement('div');tmp.innerHTML=s||'';return tmp.textContent||tmp.innerText||''}})})()